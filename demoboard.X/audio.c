#include "audio.h"
#include <xc.h>

#define STILL_ALIVE
#include "songs.h"

unsigned short sine[] =
{
0x80,0x86,0x8c,0x92,0x98,0x9e,0xa5,0xaa,
0xb0,0xb6,0xbc,0xc1,0xc6,0xcb,0xd0,0xd5,
0xda,0xde,0xe2,0xe6,0xea,0xed,0xf0,0xf3,
0xf5,0xf8,0xfa,0xfb,0xfd,0xfe,0xfe,0xff,
0xff,0xff,0xfe,0xfe,0xfd,0xfb,0xfa,0xf8,
0xf5,0xf3,0xf0,0xed,0xea,0xe6,0xe2,0xde,
0xda,0xd5,0xd0,0xcb,0xc6,0xc1,0xbc,0xb6,
0xb0,0xaa,0xa5,0x9e,0x98,0x92,0x8c,0x86,
0x80,0x79,0x73,0x6d,0x67,0x61,0x5a,0x55,
0x4f,0x49,0x43,0x3e,0x39,0x34,0x2f,0x2a,
0x25,0x21,0x1d,0x19,0x15,0x12,0x0f,0x0c,
0x0a,0x07,0x05,0x04,0x02,0x01,0x01,0x00,
0x00,0x00,0x01,0x01,0x02,0x04,0x05,0x07,
0x0a,0x0c,0x0f,0x12,0x15,0x19,0x1d,0x21,
0x25,0x2a,0x2f,0x34,0x39,0x3e,0x43,0x49,
0x4f,0x55,0x5a,0x61,0x67,0x6d,0x73,0x79,
};

unsigned short square[] = 
{
    0x60,0xA0,
};

unsigned short triangle[] = 
{
    0x80,0x8F,0x9F,0xaf,0xbf,0xcf,0xdf,0xef,
    0xff,0xef,0xdf,0xcf,0xbf,0xaf,0x9f,0x8f,
    0x80,0x70,0x60,0x50,0x40,0x30,0x20,0x10,
    0x00,0x10,0x20,0x30,0x40,0x50,0x60,0x70,
};

void audio_setup() {
    PR1 = 256;
    _T1IP = 5;	// set interrupt priority
    _TON  = 1;	// turn on the timer
    _T1IF = 0;	// reset interrupt flag
    _T1IE = 1;	// turn on the timer1 interrupt
}

//CP: Channel Phase
//CF: Channel Frequency
static unsigned int notendx=-1;
static unsigned short cp1=0;
static unsigned short cp2=0;
static unsigned short cp3=0;
static unsigned short cp4=0;
static unsigned short cf1=0;
static unsigned short cf2=0;
static unsigned short cf3=0;
static unsigned short cf4=0;
static unsigned short filt;

static unsigned short samplendx=0;

void __attribute__((__interrupt__)) _T1Interrupt(void);
void __attribute__((__interrupt__, auto_psv)) _T1Interrupt(void)
{
    unsigned short sample=0;
    sample = sine[cp1>>9];
    sample+= square[cp2>>15];
    sample+= square[cp3>>15];
    sample+= triangle[cp4>>11];
    //sample>>=2;
    PORTB=(sample<<6);
    cp1+=cf1;
    cp2+=cf2;
    cp3+=cf3;
    cp4+=cf4;
    samplendx++;
    if(samplendx==16384) {
        samplendx=0;
        notendx++;
        if(notendx==(sizeof(c1f)/sizeof(c1f[0]))) {
            notendx=0;
        }
        
        cf1=c1f[notendx];
        cf2=c2f[notendx];
        cf3=c3f[notendx];
        cf4=c4f[notendx];
        filt=fltr[notendx];
    }
    _T1IF = 0;
}
