#include "audio.h"
#include <xc.h>


uint16_t freqs[] = 
{
8,9,9,10,10,11,12,12,13,14,15,15,16,17,18,19,21,22,23,25,26,28,29,31,33,35,37,39,41,44,46,49,52,55,58,62,65,69,73,78,82,87,93,98,104,110,117,124,131,139,147,156,165,175,185,196,208,220,233,247,262,277,294,311,330,349,370,392,416,440,466,494,524,555,588,623,660,699,740,784,831,880,933,988,1047,1109,1175,1245,1319,1398,1481,1569,1662,1761,1866,1977,2094,2219,2351,2490,2638,2795,2961,3138,3324,3522,3731,3953,4188,4437,4701,4981,5277,5591,5923,6275,6648,7044,7462,7906,8376,8874,9402,9961,10554,11181,11846,12550
};

int16_t sine[] =
{
    0x0000, 0x0006, 0x000C, 0x0012, 0x0018, 0x001E, 0x0024, 0x002A,
    0x0030, 0x0036, 0x003B, 0x0041, 0x0046, 0x004B, 0x0050, 0x0055,
    0x0059, 0x005E, 0x0062, 0x0066, 0x0069, 0x006C, 0x0070, 0x0072,
    0x0075, 0x0077, 0x0079, 0x007B, 0x007C, 0x007D, 0x007E, 0x007E,
    0x007F, 0x007E, 0x007E, 0x007D, 0x007C, 0x007B, 0x0079, 0x0077,
    0x0075, 0x0072, 0x0070, 0x006C, 0x0069, 0x0066, 0x0062, 0x005E,
    0x0059, 0x0055, 0x0050, 0x004B, 0x0046, 0x0041, 0x003B, 0x0036,
    0x0030, 0x002A, 0x0024, 0x001E, 0x0018, 0x0012, 0x000C, 0x0006,
    0x0000, 0xFFFA, 0xFFF4, 0xFFEE, 0xFFE8, 0xFFE2, 0xFFDC, 0xFFD6,
    0xFFD0, 0xFFCA, 0xFFC5, 0xFFBF, 0xFFBA, 0xFFB5, 0xFFB0, 0xFFAB,
    0xFFA7, 0xFFA2, 0xFF9E, 0xFF9A, 0xFF97, 0xFF94, 0xFF90, 0xFF8E,
    0xFF8B, 0xFF89, 0xFF87, 0xFF85, 0xFF84, 0xFF83, 0xFF82, 0xFF82,
    0xFF81, 0xFF82, 0xFF82, 0xFF83, 0xFF84, 0xFF85, 0xFF87, 0xFF89,
    0xFF8B, 0xFF8E, 0xFF90, 0xFF94, 0xFF97, 0xFF9A, 0xFF9E, 0xFFA2,
    0xFFA7, 0xFFAB, 0xFFB0, 0xFFB5, 0xFFBA, 0xFFBF, 0xFFC5, 0xFFCA,
    0xFFD0, 0xFFD6, 0xFFDC, 0xFFE2, 0xFFE8, 0xFFEE, 0xFFF4, 0xFFFA,
};

int16_t square[] = 
{
    0x007F, 0x007F, 0x007F, 0x007F, 0x007F, 0x007F, 0x007F, 0x007F, 
    0x007F, 0x007F, 0x007F, 0x007F, 0x007F, 0x007F, 0x007F, 0x007F, 
    0x007F, 0x007F, 0x007F, 0x007F, 0x007F, 0x007F, 0x007F, 0x007F, 
    0x007F, 0x007F, 0x007F, 0x007F, 0x007F, 0x007F, 0x007F, 0x007F, 
    0x007F, 0x007F, 0x007F, 0x007F, 0x007F, 0x007F, 0x007F, 0x007F, 
    0x007F, 0x007F, 0x007F, 0x007F, 0x007F, 0x007F, 0x007F, 0x007F, 
    0x007F, 0x007F, 0x007F, 0x007F, 0x007F, 0x007F, 0x007F, 0x007F, 
    0x007F, 0x007F, 0x007F, 0x007F, 0x007F, 0x007F, 0x007F, 0x0000, 
    0xFF81, 0xFF81, 0xFF81, 0xFF81, 0xFF81, 0xFF81, 0xFF81, 0xFF81, 
    0xFF81, 0xFF81, 0xFF81, 0xFF81, 0xFF81, 0xFF81, 0xFF81, 0xFF81, 
    0xFF81, 0xFF81, 0xFF81, 0xFF81, 0xFF81, 0xFF81, 0xFF81, 0xFF81, 
    0xFF81, 0xFF81, 0xFF81, 0xFF81, 0xFF81, 0xFF81, 0xFF81, 0xFF81, 
    0xFF81, 0xFF81, 0xFF81, 0xFF81, 0xFF81, 0xFF81, 0xFF81, 0xFF81, 
    0xFF81, 0xFF81, 0xFF81, 0xFF81, 0xFF81, 0xFF81, 0xFF81, 0xFF81, 
    0xFF81, 0xFF81, 0xFF81, 0xFF81, 0xFF81, 0xFF81, 0xFF81, 0xFF81, 
    0xFF81, 0xFF81, 0xFF81, 0xFF81, 0xFF81, 0xFF81, 0xFF81, 0x0000, 
};

int16_t triangle[] = 
{
    0x80,0x8F,0x9F,0xaf,0xbf,0xcf,0xdf,0xef,
    0xff,0xef,0xdf,0xcf,0xbf,0xaf,0x9f,0x8f,
    0x80,0x70,0x60,0x50,0x40,0x30,0x20,0x10,
    0x00,0x10,0x20,0x30,0x40,0x50,0x60,0x70,
};

static uint8_t notes[4]={0,0,0,0};

void audio_setup() {
   notes[0]=0;
   notes[1]=0;
   notes[2]=0;
   notes[3]=0;
    PR1 = 256;
    _T1IP = 5;	// set interrupt priority
    _TON  = 1;	// turn on the timer
    _T1IF = 0;	// reset interrupt flag
    _T1IE = 1;	// turn on the timer1 interrupt
}

//CP: Channel Phase
//CF: Channel Frequency
static uint16_t cp1,cp2,cp3,cp4;

static  int16_t ca1,ca2,ca3,ca4;

static uint16_t cf1,cf2,cf3,cf4;

void __attribute__((__interrupt__)) _T1Interrupt(void);
void __attribute__((__interrupt__, auto_psv)) _T1Interrupt(void)
{
   int16_t sample=0;

   sample += sine[cp1>>9]*ca1;
   sample += sine[cp2>>9]*ca2;
   sample += sine[cp3>>9]*ca3;
   sample += sine[cp4>>9]*ca4;
   
   sample^=0x8000;
   PORTB=(sample);

   cp1+=cf1;
   cp2+=cf2;
   cp3+=cf3;
   cp4+=cf4;

   _T1IF = 0;
}



void process_midi(uint8_t cmd,uint8_t k,uint8_t v)
{
   v>>=2;
   if(cmd==0x90)
   {
      if(notes[0]==0)
      {
         notes[0]=k;
         cf1=freqs[k];
         ca1=v;
      }
      else if(notes[1]==0)
      {
         notes[1]=k;
         cf2=freqs[k];
         ca2=v;
      }
      else if(notes[2]==0)
      {
         notes[2]=k;
         cf3=freqs[k];
         ca3=v;
      }
      else if(notes[3]==0)
      {
         notes[3]=k;
         cf4=freqs[k];
         ca4=v;
      }
   }
   if(cmd==0x80)
   {
      if(notes[0]==k)
      {
         notes[0]=0;
         cf1=0;
         ca1=0;
      }
      else if(notes[1]==k)
      {
         notes[1]=0;
         cf2=0;
         ca2=0;
      }
      else if(notes[2]==k)
      {
         notes[2]=0;
         cf3=0;
         ca3=0;
      }
      else if(notes[3]==k)
      {
         notes[3]=0;
         cf4=0;
         ca4=0;
      }
   }

}
